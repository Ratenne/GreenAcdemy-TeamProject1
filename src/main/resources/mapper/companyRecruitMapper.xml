<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.company.recruit.mapper.CompanyRecruitMapper">  

 
 <select id="companyRecruitList">
 
 SELECT
    COMPANY_RECRUIT_IDX,
    COMPANY_ID,
    COMPANY_NAME,
    RECRUIT_TITLE,
    COMPANY_JOB,
    GETMAN,
    REGION_IDX,
    COMPANY_ADDRESS,
    COMPANY_INFO,
    APPLICATION_DEADLINE,
    COMPANY_ESTABLISH,
    COMPANY_RECRUIT_REGDATE,
    VIEWS
    
 FROM
    COMPANY_RECRUIT
    
 ORDER BY
 	VIEWS DESC
 FETCH FIRST 6 ROWS ONLY
	 
 </select>
 
 <select id="searchByKeyword" parameterType="String" resultType="com.green.company.recruit.vo.CompanyRecruitVo">
	SELECT * 
	FROM COMPANY_RECRUIT 
	WHERE RECRUIT_TITLE LIKE '%' || #{keyword} || '%'
 </select>
 

   
 	<insert id="insertUserResume">
 	
 	</insert>
 	
 	<select id="selectCompanyRecruitList">
 		SELECT
		    COMPANY_ID,
		    COMPANY_PASSWD,
		    COMPANY_USER_NAME,
		    COMPANY_PHONE,
		    COMPANY_NAME,
		    COMPANY_BCODE,
		    COMPANY_BOSS_NAME,
		    COMPANY_EMAIL,
		    COMPANY_USER_EMAIL,
		    COMPANY_REGDATE,
		    COMPANY_ESTABLISH
		FROM
		    COMPANY_USERS
		WHERE 
			COMPANY_ID = #{company_id}
 	</select>
 	
 	<select id="getCompanyRecruit">
 		SELECT
		    *
		FROM
		    COMPANY_RECRUIT CR
		JOIN
		    COMMON_COMPANY_RECRUIT_SKILL CCRS
		ON
		    CR.COMPANY_RECRUIT_IDX = CCRS.COMPANY_RECRUIT_IDX
		WHERE
		    CR.COMPANY_RECRUIT_IDX = #{company_recruit_idx}
 		
 	</select>
 	
 	<select id="getCompanyRecruitAlications">
 		SELECT
		 *
		FROM
		    COMPANY_RECRUIT CR
		JOIN 
		    APPLICATIONS A
		ON
		    CR.COMPANY_RECRUIT_IDX = A.COMPANY_RECRUIT_IDX
		WHERE
    		CR.COMPANY_RECRUIT_IDX = #{company_recruit_idx}
 	</select>
  	
  	<insert id="setCompanyRecruit" > 
  		INSERT 
  			INTO 
  		COMPANY_RECRUIT (
		      COMPANY_RECRUIT_IDX
		    , COMPANY_ID
		    , COMPANY_NAME
		    , RECRUIT_TITLE
		    , COMPANY_JOB
		    , GETMAN
		    , REGION_IDX
		    , COMPANY_ADDRESS
		    , COMPANY_INFO
		    , APPLICATION_DEADLINE
		    , COMPANY_ESTABLISH
		    
				) VALUES (
				      COMPANY_RECRUIT_SEQ.NEXTVAL
				    , #{company_id}
	</insert>
	  	
  	<select id="getCompanyRecruitIdx">
  		SELECT 
  			COMPANY_RECRUIT_IDX
		FROM 
			COMPANY_RECRUIT
		WHERE
		    COMPANY_ID = #{ company_id }
		ORDER BY 
			COMPANY_RECRUIT_IDX DESC
		FETCH FIRST 1 ROW ONLY
  	</select>
  	
  <select id="getCompanyRecruitList">
	SELECT 
	   *
	FROM 
	    COMPANY_RECRUIT CR
	LEFT JOIN (
	    SELECT 
	        COMPANY_RECRUIT_IDX, 
	        LISTAGG(DISTINCT SKILL_NAME, ', ') WITHIN GROUP (ORDER BY SKILL_NAME) AS SKILL_NAME
	    FROM 
	        COMMON_COMPANY_RECRUIT_SKILL
	        
	    <if test="skillListCheck != null ">    
	    WHERE 
	    	SKILL_NAME IN
	     <foreach item="skill" index="index" collection="skillListCheck"
	      open="(" separator="," close=")">
	        #{ skill.skill_name }
	  	 </foreach>
	    </if>
	    
	     <if test="skillListCheck == null ">    
	    
	    </if>
	    
	    GROUP BY COMPANY_RECRUIT_IDX
	) CCRK ON CCRK.COMPANY_RECRUIT_IDX = CR.COMPANY_RECRUIT_IDX
	JOIN 
	    REGION R ON CR.REGION_IDX = R.REGION_IDX
	<if test="regionListCheck != null">
	WHERE 
	    CR.REGION_IDX IN 
	    <foreach item="region" index="index" collection="regionListCheck"
	      open="(" separator="," close=")">
	        #{ region.region_idx }
  	 	</foreach>
	</if>
	<if test="regionListCheck == null">
	
	</if>   
	
	    AND CR.RECRUIT_TITLE LIKE '%' || #{ recruit_title } || '%'
	    
	ORDER BY 
	    CR.COMPANY_RECRUIT_REGDATE DESC
	 OFFSET #{ startRow } ROWS FETCH NEXT #{ endRow } ROWS ONLY
	 
	  
	
  </select>
  
  <select id="getCompanyRecruitListCount">
  		SELECT 
	   COUNT(*)
	FROM 
	    COMPANY_RECRUIT CR
	LEFT JOIN (
	    SELECT 
	        COMPANY_RECRUIT_IDX, 
	        LISTAGG(DISTINCT SKILL_NAME, ', ') WITHIN GROUP (ORDER BY SKILL_NAME) AS SKILL_NAME
	    FROM 
	        COMMON_COMPANY_RECRUIT_SKILL
	        
	    <if test="skillListCheck != null ">    
	    WHERE 
	    	SKILL_NAME IN
	     <foreach item="skill" index="index" collection="skillListCheck"
	      open="(" separator="," close=")">
	        #{ skill.skill_name }
	  	 </foreach>
	    </if>
	    
	     <if test="skillListCheck == null ">    
	    
	    </if>
	    
	    GROUP BY COMPANY_RECRUIT_IDX
	) CCRK ON CCRK.COMPANY_RECRUIT_IDX = CR.COMPANY_RECRUIT_IDX
	JOIN 
	    REGION R ON CR.REGION_IDX = R.REGION_IDX
	<if test="regionListCheck != null">
	WHERE 
	    CR.REGION_IDX IN 
	    <foreach item="region" index="index" collection="regionListCheck"
	      open="(" separator="," close=")">
	        #{ region.region_idx }
  	 	</foreach>
	</if>
	<if test="regionListCheck == null">
	
	</if>   
	
	    AND CR.RECRUIT_TITLE LIKE '%' || #{ recruit_title } || '%'
	    
  </select>
  

</mapper>

















